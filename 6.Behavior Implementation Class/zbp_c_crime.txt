CLASS zbp_c_crime DEFINITION PUBLIC ABSTRACT FINAL FOR BEHAVIOR OF z_c_crime.
ENDCLASS.

CLASS zbp_c_crime IMPLEMENTATION.
ENDCLASS.
CLASS lhc_crime DEFINITION INHERITING FROM cl_abap_behavior_handler.
  PRIVATE SECTION.

    METHODS get_instance_authorizations FOR INSTANCE AUTHORIZATION
      IMPORTING keys REQUEST requested_authorizations FOR crime RESULT result.

    METHODS create_crime FOR DETERMINE ON SAVE
      IMPORTING keys FOR crime~create_crime.

ENDCLASS.

CLASS lhc_crime IMPLEMENTATION.

  METHOD get_instance_authorizations.
  ENDMETHOD.

  METHOD create_crime.
    " check if TravelID is already filled
    READ ENTITIES OF z_c_crime IN LOCAL MODE
      ENTITY crime
        FIELDS ( crimeId ) WITH CORRESPONDING #( keys )
      RESULT DATA(lt_crime).

    " remove lines where TravelID is already filled.
    DELETE lt_crime WHERE crimeId IS NOT INITIAL.
    IF lt_crime IS INITIAL.
      RETURN.
    ENDIF.

    " Select max travel ID
    SELECT SINGLE MAX( crimeId ) AS crimeid
        FROM  z_c_crime
        INTO @DATA(lv_maxcrime).
*    " Set the travel ID
    MODIFY ENTITIES OF z_c_crime IN LOCAL MODE
    ENTITY crime
      UPDATE
        FROM VALUE #( FOR crime IN lt_crime INDEX INTO lv_index (
          %tky              = crime-%tky
          crimeId          = 'CM' && CONV znumc06( lv_maxcrime+2   + lv_index )
          %control-crimeId = if_abap_behv=>mk-on ) )
          MAPPED DATA(mapped)
    REPORTED DATA(update_reported).
    reported = CORRESPONDING #( DEEP update_reported ).
  ENDMETHOD.

ENDCLASS.